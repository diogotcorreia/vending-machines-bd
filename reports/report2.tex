\documentclass[12pt,a4paper]{article}
\usepackage[legalpaper, portrait, margin=2cm]{geometry}
\usepackage{fancyhdr}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{graphicx}
\usepackage{wrapfig}
\usepackage{blindtext}
\usepackage{hyperref}
\usepackage{enumitem}
\usepackage{pdflscape}
\usepackage{svg}

\graphicspath{ {./} }
\hypersetup{
  colorlinks=true,
  linkcolor=blue,
  filecolor=magenta,
  urlcolor=blue,
  citecolor=blue,
  pdftitle={Relatório BD - Entrega 2 - 2021/2022},
  pdfpagemode=FullScreen,
}

\pagestyle{fancy}
\fancyhf{}
\rhead{Grupo \textbf{8}}
\lhead{Relatório Entrega 2 BD 2021/2022 LEIC-A}
\cfoot{Diogo Gaspar (99207), Diogo Correia (99211) e Tomás Esteves (99341)}

\renewcommand{\footrulewidth}{0.2pt}

\renewcommand{\labelitemii}{$\circ$}
\renewcommand{\labelitemiii}{$\diamond$}
\newcommand{\op}{\text}

\newlist{constraintsList}{itemize}{4}
\setlist[constraintsList]{itemsep=1pt, topsep=1pt, label=\protect\mpbullet}


\begin{document}
  \begin{titlepage}
    \begin{center}
      \vspace*{5cm}

      \Huge
      \textbf{Projeto BD - Parte 2}

      \vspace{0.5cm}
      \LARGE
      Grupo 008 | Turno L20 | LEIC-A

      \vspace{0.5cm}
      \large
      Prof. João Aparício | Prof. Leonardo Alexandre

      \vfill
    \end{center}
    \large
    \begin{itemize}
      \item[] \textbf{Diogo Gaspar} (99207) - 34\% - Xh
      \item[] \textbf{Diogo Correia} (99211) - 33\% - Xh
      \item[] \textbf{Tomás Esteves} (99341) - 33\% - Xh
    \end{itemize}
  \end{titlepage}

  \section*{Modelo Relacional}

  \ttfamily

  \noindent
  point\_of\_retail(\underline{address}, name)
  
  \vspace*{10pt}

  \noindent
  ivm(\underline{serial\_number, manuf})

  \vspace*{10pt}

  \noindent
  installed\_at(\underline{address, serial\_number, manuf}, nr)
  \begin{itemize}[nosep]
    \item address: FK(point\_of\_retail)
    \item serial\_number, manuf: FK(ivm.serial\_number, ivm.manuf)
  \end{itemize}

  \vspace*{10pt}

  \noindent
  retailer(\underline{tin}, name)
  \begin{itemize}[nosep]
    \item UNIQUE(name)
  \end{itemize}

  \vspace*{10pt}

  \noindent
  category(\underline{name})
  \begin{itemize}[nosep]
    \item \textsf{\textbf{(IC-1)}} name \textsf{must exist in} simple\_category \textsf{or} super\_category
    \item \textsf{\textbf{(IC-2)}} name \textsf{never exists in both} simple\_category \textsf{and} super\_category \textsf{simultaneously}
  \end{itemize}

  \vspace*{10pt}

  \noindent
  simple\_category(\underline{name})
  \begin{itemize}[nosep]
    \item name: FK(category)
  \end{itemize}

  \vspace*{10pt}

  \noindent
  super\_category(\underline{name})
  \begin{itemize}[nosep]
    \item name: FK(category)
    \item \textsf{\textbf{(IC-1)} Every} super\_category \textsf{must participate in the} has\_other \textsf{association}
  \end{itemize}

  \vspace*{10pt}

  \noindent
  has\_other(\underline{category\_name}, super\_category\_name)
  \begin{itemize}[nosep]
    \item category\_name: FK(category.name)
    \item super\_category\_name: FK(super\_category.name)
    \item \textsf{\textbf{(IC-1)}} category\_name \textsf{can't be the same as the} super\_category\_name
    % TODO is there a better way to say this?
    \item \textsf{\textbf{(IC-2)} There can't be cycles in the categories' hierarchies}
  \end{itemize}

  \vspace*{10pt}

  \noindent
  product(\underline{ean}, descr)
  \begin{itemize}
    \item \textsf{\textbf{(IC-1)} Every} product \textsf{must participate in the} has \textsf{association}
  \end{itemize}

  \vspace*{10pt}

  \noindent
  has(\underline{ean, category\_name})
  \begin{itemize}[nosep]
    \item ean: FK(product)
    \item category\_name: FK(category.name)
  \end{itemize}

  % SHELVES

  \vspace*{10pt}

  \noindent
  shelf(\underline{serial\_number, manuf, nr}, height, category\_name)
  \begin{itemize}[nosep]
    \item serial\_number, manuf: FK(ivm.serial\_number, ivm.manuf)
    \item category\_name: FK(category.name)
    % TODO usar 'shelf' em vez da key?
    \item \textsf{\textbf{(IC-1)}} serial\_number, manuf, nr \textsf{must exist in one of} warm\_shelf \textsf{or}\\ ambient\_temperature\_shelf \textsf{or} cold\_shelf
    \item \textsf{\textbf{(IC-2)}} serial\_number, manuf, nr \textsf{never exists in more than one of} warm\_shelf \textsf{and}\\ ambient\_temperature\_shelf \textsf{or} cold\_shelf \textsf{simultaneously}
  \end{itemize}

  \vspace*{10pt}

  \noindent
  warm\_shelf(\underline{serial\_number, manuf, nr})
  \begin{itemize}[nosep]
    \item serial\_number, manuf, nr: FK(shelf.serial\_number, shelf.manuf, shelf.nr)
  \end{itemize}

  \vspace*{10pt}

  \noindent
  ambient\_temperature\_shelf(\underline{serial\_number, manuf, nr})
  \begin{itemize}[nosep]
    \item serial\_number, manuf, nr: FK(shelf.serial\_number, shelf.manuf, shelf.nr)
  \end{itemize}

  \vspace*{10pt}

  \noindent
  cold\_shelf(\underline{serial\_number, manuf, nr})
  \begin{itemize}[nosep]
    \item serial\_number, manuf, nr: FK(shelf.serial\_number, shelf.manuf, shelf.nr)
  \end{itemize}

  \vspace*{10pt}

  \noindent
  planogram(\underline{serial\_number, manuf, nr, ean}, faces, units, loc)
  \begin{itemize}[nosep]
    \item serial\_number, manuf, nr: FK(shelf.serial\_number, shelf.manuf, shelf.nr)
    \item ean: FK(product)
  \end{itemize}

  \vspace*{10pt}

  \noindent
  replenishment\_event(\underline{serial\_number, manuf, nr, ean, instant}, units, tin)
  \begin{itemize}[nosep]
    \item serial\_number, manuf, nr, ean: FK(planogram.serial\_number, planogram.manuf,\\ planogram.nr, planogram.ean)
    \item tin: FK(retailer)
    % TODO is this right?
    \item \textsf{\textbf{(IC-1)}} units \textsf{must be less than or equal to} planogram.units \textsf{of the associated} planogram
    \item \textsf{\textbf{(IC-2)} The product with} ean \textsf{must have} (has) \textsf{the} category \textsf{with} shelf.category\_name \textsf{of the} shelf \textsf{identified by} serial\_number, manuf, nr
    \item \textsf{\textbf{(IC-3)} The product with} ean \textsf{must have} (has) \textsf{one of the categories} (category) \textsf{that its} retailer \textsf{, identified by} tin\textsf{, is} responsible\_for
    \end{itemize}

  \vspace*{10pt}

  \noindent
  responsible\_for(\underline{serial\_number, manuf, tin, category\_name})
  \begin{itemize}[nosep]
    \item serial\_number, manuf: FK(ivm.serial\_number, ivm.manuf)
    \item tin: FK(retailer)
    \item category\_name: FK(category.name)
  \end{itemize}

  \sffamily
  \section*{Álgebra Relacional}

  \begin{enumerate}
    \item Para uma dada Categoria (e.g., "Barras Energéticas"), liste todos os produtos (EAN e designação) que foram repostos em mais de 10 unidades após uma determinada data (e.g., 2021/12/31)

    % TODO use group by + sum
    \[
      \begin{aligned}
      &r \leftarrow \rho_{\op{name}\mapsto\op{category\_name}}(\op{category}) \bowtie \op{has} \bowtie \op{product} \bowtie\\
      & \quad\quad\pi_{\op{serial\_number},\op{manuf},\op{nr},\op{ean}}(\op{planogram}) \bowtie \op{replenishment\_event}\\
      &\pi_{\op{ean},~\op{descr}} \left(
        \sigma_{\op{units} > 10~\land~\op{instant} > \text{2021/12/31}~\land~\op{name} = \text{'Barras Energéticas'}} (r)
      \right)
      \end{aligned}
    \]

    \item Para um dado Produto identificado pelo EAN (e.g., 9002490100070), liste todas as IVMs onde este produto poderá ser apresentado (i.e., números de série das IVMs)

    % TODO precisamos de mais relações além do planogram?
    \[
      \begin{aligned}
        \pi_{\op{serial\_number}}\left(\sigma_{\op{ean}='9002490100070'}\left(\op{product} \bowtie \op{planogram} \bowtie \op{ivm}\right)\right)
      \end{aligned}
    \]

    \item Para uma dada categoria (e.g., "Sopas Take-Away"), apresente o seu número de subcategorias considerando apenas os seus descendentes diretos

    \[
      _{\op{super\_category\_name}}G_{\op{count}()\mapsto \op{count}}\left(\sigma_{\op{super\_category\_name}=\text{'Sopas Take-Away'}}(\op{has\_other})\right)
    \]

    \item Indique o EAN e a designação do produto mais reposto

    \[
      \begin{aligned}
        &r \leftarrow \op{product} \bowtie \quad\quad\pi_{\op{serial\_number},\op{manuf},\op{nr},\op{ean}}(\op{planogram}) \bowtie \op{replenishment\_event}\\
        &l \leftarrow \rho_{(1->\op{serial\_number})} (_{\op{ean,descr}} G_{sum(units)}(r))\\
        &\pi_{\op{ean},~\op{descr}}\left(
          \sigma_{\op{max} = \op{total\_sum}}(L \times (\rho_{(1->\op{max})} ( G_{max(total\_sum)}(L)) ))
        \right)
        \end{aligned}
    \]
  \end{enumerate}

  // TODO
\end{document}
